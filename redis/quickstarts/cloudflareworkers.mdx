---
title: " Cloudflare Workers"
---

### Database Setup

Create a Redis database using [Upstash Console](https://console.upstash.com) or
[Upstash CLI](https://github.com/upstash/cli).

### Project Setup

We will use **C3 (create-cloudflare-cli)** command-line tool to create our application. You can open a new terminal window and run C3 using the prompt below.

<CodeGroup>

```shell npm
npm create cloudflare@latest -- upstash-redis-worker
```

```shell yarn
yarn create cloudflare upstash-redis-worker
```

```shell pnpm
pnpm create cloudflare upstash-redis-worker
```

</CodeGroup>

This will create a new Cloudflare Workers project:

```text
âžœ  npm create cloudflare@latest -- upstash-redis-worker

> npx
> create-cloudflare upstash-redis-worker


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ‘‹ Welcome to create-cloudflare v2.50.8!
ðŸ§¡ Let's get started.
ðŸ“Š Cloudflare collects telemetry about your usage of Create-Cloudflare.

Learn more at: https://github.com/cloudflare/workers-sdk/blob/main/packages/create-cloudflare/telemetry.md
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â•­ Create an application with Cloudflare Step 1 of 3
â”‚
â”œ In which directory do you want to create your application?
â”‚ dir ./upstash-redis-worker
â”‚
â”œ What would you like to start with?
â”‚ category Hello World example
â”‚
â”œ Which template would you like to use?
â”‚ type Worker only
â”‚
â”œ Which language do you want to use?
â”‚ lang TypeScript
â”‚
â”œ Copying template files
â”‚ files copied to project directory
â”‚
â”œ Updating name in `package.json`
â”‚ updated `package.json`
â”‚
â”œ Installing dependencies
â”‚ installed via `npm install`
â”‚
â•° Application created 

...

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸŽ‰  SUCCESS  Application created successfully!
```

We will also install the **Upstash Redis SDK** to connect to Redis.

```bash
npm install @upstash/redis
```

### The Code

Here is a Worker template to configure and test Upstash Redis connection.

<CodeGroup>

```ts src/index.ts
import { Redis } from "@upstash/redis/cloudflare";

export interface Env {
  UPSTASH_REDIS_REST_URL: string;
  UPSTASH_REDIS_REST_TOKEN: string;
}

export default {
  async fetch(
    request: Request,
    env: Env,
    ctx: ExecutionContext
  ): Promise<Response> {
    const redis = Redis.fromEnv(env);
    const count = await redis.incr("counter");
    return new Response(JSON.stringify({ count }));
  },
};
```

```js src/index.js
import { Redis } from "@upstash/redis/cloudflare";

export default {
  async fetch(request, env, ctx) {
    const redis = Redis.fromEnv(env);
    const count = await redis.incr("counter");
    return new Response(JSON.stringify({ count }));
  },
};
```

</CodeGroup>

### Configure Credentials

Navigate to [Upstash Console](https://console.upstash.com) and copy/paste your `UPSTASH_REDIS_REST_URL` and `UPSTASH_REDIS_REST_TOKEN` to your `wrangler.toml` as below.

<CodeGroup>

```yaml wrangler.toml
[vars]
UPSTASH_REDIS_REST_URL="REPLACE_HERE"
UPSTASH_REDIS_REST_TOKEN="REPLACE_HERE"
```

```yaml wrangler.jsonc
{
  "vars": {
    "UPSTASH_REDIS_REST_URL": "REPLACE_HERE",
    "UPSTASH_REDIS_REST_TOKEN": "REPLACE_HERE"
  }
}
```

</CodeGroup>

### Test and Deploy

You can test the function locally with `npx wrangler dev`

Deploy your function to Cloudflare with `npx wrangler deploy`

The endpoint of the function will be provided to you, once the deployment is done.

## Advanced Usage: TCP with Durable Objects

The basic example above uses the `@upstash/redis` HTTP client, which is optimal for most use cases. However, for specific scenarios, you can leverage TCP connection and [Cloudflare Durable Objects](https://developers.cloudflare.com/durable-objects/).

**Use TCP with Durable Objects when:**
- Your traffic is concentrated in a single region where your Upstash Redis primary is located
- You have predictable, region-specific workloads

**Stick with HTTP client when:**
- You have a global audience (recommended for most applications)
- Your traffic patterns are distributed across multiple regions
- You want simpler deployment and configuration

To get started, first install the `ioredis` package for TCP connections:

```bash
npm install ioredis
```

Then, define the durable object class:

<CodeGroup>

```ts src/index.ts
import { DurableObject } from "cloudflare:workers";
import Redis from "ioredis";

export class RedisDurableObject extends DurableObject<Env> {
  public client: Redis;

  constructor(ctx: DurableObjectState, env: Env) {
    // Required, as we're extending the base class.
    super(ctx, env);
    this.client = new Redis(env.REDIS_URL);
  };

  getRedis(): Redis {
    return this.client;
  };
};
```

</CodeGroup>

Next, update your `wrangler.toml` to include the Durable Object class:

<CodeGroup>

```yaml wrangler.toml
[[durable_objects]]
name = "REDIS_CLIENT"
class_name = "RedisDurableObject"

[[migrations]]
tag = "v1"
new_classes = ["RedisDurableObject"]
```

```yaml wrangler.jsonc
{
  "durable_objects": {
    "bindings": [
      {
        "name": "REDIS_CLIENT",
        "class_name": "RedisDurableObject"
      }
    ]
  },
  "migrations": [
    {
      "tag": "v1",
      "new_classes": ["RedisDurableObject"]
    }
  ]
}
```

</CodeGroup>

Finally, update your worker code to use the Durable Object:

<CodeGroup>

```ts src/index.ts
export default {
  async fetch(request, env, ctx) {
    const id = env.REDIS_CLIENTS.idFromName("client");
    const clientStub = env.REDIS_CLIENTS.get(id);
    const redis = clientStub.getRedis();

    const count = await redis.incr("counter");

    return new Response(JSON.stringify({ count }));
  }
};
```

</CodeGroup>

With this approach, the TCP redis client will be shared across worker invocations, allowing for efficient connection reuse.

If you want to have a redis client per region, you can use `idFromName` with a region-specific name, like:
```ts
const id = env.REDIS_CLIENTS.idFromName(`${request.cf?.colo || "unknown-region"}`)
```

## Repositories

Javascript:
[https://github.com/upstash/upstash-redis/tree/main/examples/cloudflare-workers](https://github.com/upstash/upstash-redis/tree/main/examples/cloudflare-workers)

Typescript:
[https://github.com/upstash/upstash-redis/tree/main/examples/cloudflare-workers-with-typescript](https://github.com/upstash/upstash-redis/tree/main/examples/cloudflare-workers-with-typescript)
